# The Spatial Experience: Пространственная Механика tLOS

Этот документ определяет "физику" и ощущения от взаимодействия с **The Last OS**. В tLOS интерфейс — это не набор страниц, а материальный мир, подчиняющийся законам пространства и намерений.

---

## 1. The Infinite Canvas (Бесконечный Холст)

Рабочее пространство tLOS — это бесконечная 2D-плоскость (с поддержкой слоев глубины), где данные и агенты располагаются не в файлах, а в координатах.

-   **Виртуализация**: Только видимые в данный момент объекты рендерятся в DOM/WebGPU. Используется **RBush (Spatial Index)** для мгновенного поиска объектов в окне просмотра.
-   **Tiling**: Холст разбит на логические тайлы для кэширования и ленивой загрузки тяжелых медиа-ресурсов.

---

## 2. Coordinate System: World vs Screen Space

tLOS использует дуальную систему координат, типичную для игровых движков:

-   **World Space (Мировые координаты)**: Абсолютные координаты объекта в Grid (м, у). Неизменны при перемещении камеры.
-   **Screen Space (Экранные координаты)**: Пиксели на дисплее пользователя.
-   **Mapping Logic**:
    -   `ScreenToWorld`: Используется для обработки кликов и жестов (учитывает текущий Zoom и Offset камеры).
    -   `WorldToScreen`: Используется для отрисовки объектов в правильном масштабе.

---

## 3. Navigation: Pan, Zoom, God Mode

Свобода перемещения — критическая часть UX.

-   **Smooth Zoom**: Масштабирование всегда происходит "в точку курсора" (**Focal Point Preservation**).
    -   *Math*: Перед изменением масштаба фиксируется координата мыши в World Space. После масштабирования смещение (Pan) корректируется так, чтобы эта точка осталась под курсором.
-   **God Mode (Взгляд сверху)**: Специальный режим камеры с высоким уровнем абстракции.
    -   При отдалении (Zoom Out < 0.1) окна превращаются в семантические точки или кластеры.
    -   Отображаются связи между агентами (Hives) в виде направленных графов.

---

## 4. Window Physics (Физика Окон)

Окна в tLOS — это физические сущности с массой и инерцией.

### 4.1. Group Drag (Магнитные окна)
При сближении двух окон на расстояние < 20px срабатывает "магнитное притяжение" (**Magnetic Snapping**).
-   **Tile Clustering**: Окна "слипаются" краями, образуя единую группу.
-   **Joint Movement**: При перемещении одного окна в группе перемещаются все связанные окна (Spring Physics).

### 4.2. Pinning & HUD (Закрепление)
-   **Persistent HUD (Docking)**: Элементы (например, Omnibar или важные метрики), закрепленные в системном слое (Screen Space), не зависят от перемещения камеры по холсту.
-   **World Pinning (Anchoring)**: Агенты или данные могут быть "приколоты" к мировым координатам, оставаясь на месте, пока Суверен путешествует по Grid.

---

## 5. The Omnibar: Command Center

Omnibar — это единственный инструмент, который всегда под рукой.

-   **Chat-to-UI (GenUI)**:
    -   Ввод намерения (напр. "Спланируй бюджет") -> AI оркестрирует выбор WIT-акторов.
    -   Система динамически генерирует подходящий UI-компонент (напр. таблицу или график) прямо на холсте перед пользователем.
-   **Universal Entry**: Поиск по всему Grid (коду, данным, агентам) с мгновенным перемещением камеры к найденному объекту (**Jump-to-Point**).

---

## 5.1. Модель Взаимодействия (Interaction Model)
Для эффективной работы в пространстве предусмотрены "горячие клавиши" и жесты:
-   **Navigation**:
    -   `Space + ЛКМ` (или скролл двумя пальцами): Перемещение камеры (Pan).
    -   `Колесо мыши` (или щипок): Масштабирование (Zoom).
    -   `Cmd + K` (или `Ctrl + K`): Вызов Omnibar.
-   **Windowing**:
    -   `Double-Click` по заголовку: Выбор всей группы связанных окон.
    -   `Shift + Click`: Множественный выбор для групповых операций.
    -   `Cmd + L`: Locked Mode (Фиксация окон, только контент активен).

---

## 6. Технический стек реализации

-   **Render**: WebGPU / Canvas 2D.
-   **Sync**: Yjs (CRDT) для синхронизации координат между устройствами в реальном времени.
-   **Physics Engine**: Rapier.rs (Wasm) для расчета столкновений и магнитных сил.
