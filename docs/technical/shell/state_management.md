# State Management: The Distributed Context Control

Этот документ описывает механизмы управления состоянием в **The Last OS (tLOS)**. Мы используем гибридную модель, разделяющую локальную реактивность, распределенный консенсус и память AI-агентов.

---

## 1. Архитектурный стек управления состоянием

Для tLOS мы выбрали связку **Actor Model + CRDT**, которая обеспечивает бесконечное масштабирование и устойчивость к конфликтам.

-   **Оркестрация (Actors)**: Каждый пользовательский процесс (Actor) в wasmCloud владеет своим локальным состоянием.
-   **Синхронизация (CRDT)**: Общие пространственные данные (Lattice) синхронизируются через бессерверные CRDT (Conflict-free Replicated Data Types).
-   **Реактивность (SolidJS)**: Фронтенд подписывается на изменения Wasm-ядра через сигналы.

---

## 1.1. Схема Состояния (State Shape)
На уровне Shell состояние представлено типизированным стором SolidJS, который является проекцией Lattice:
```typescript
type AppState = {
    components: Component[];
    viewport: { x: number; y: number; zoom: number };
    selection: string[]; // ID выбранных компонентов
};

type Component = {
    id: string;
    type: "window" | "sticky" | "widget";
    x: number; y: number;
    width: number; height: number;
    attachedTo?: string;   // Связь "магнита"
    isPinned: boolean;     // HUD vs World
    preSnapState?: { x: number, y: number, w: number, h: number }; // До прилипания
};
```

---

## 2. Модель документации: C4 + Statecharts

Мы комбинируем статические и динамические модели для полного описания потоков данных:

-   **C4 (Dynamic Diagrams)**: Используются для описания глобальных транзакций между Сувереном, Ядром и Сетью (The Grid).
-   **Statecharts (XState)**: Используются для описания внутренней логики компонентов и обработчиков системных вызовов (Syscalls).
-   **Sequence Diagrams**: Описывают порядок обмена сообщениями в протоколе wRPC между акторами.

---

## 3. Распределенная память и Пространство

Так как tLOS — это пространственная ОС, состояние привязано к координатам:

### 3.1. GeoArrow и Zero-Copy
Для передачи больших объемов пространственных данных между Wasm и GPU (WGPU) используется формат **GeoArrow**. Это минимизирует накладные расходы на сериализацию (Zero-copy).

### 3.2. MPK Coloring (Изоляция)
Мы используем **Memory Protection Keys** для "раскраски" памяти. Разные квадранты пространства могут иметь разные ключи доступа, что предотвращает утечку состояния между изолированными акторами.

---

## 4. AI-Native: Context Window Sync

tLOS спроектирован для работы с AI-агентами, что требует специфического управления состоянием:

-   **MCP (Model Context Protocol)**: Стандарт общения агентов с внешними данными. tLOS выступает как "Умный контекст", предоставляя агенту только нужные фрагменты состояния.
-   **Context CRDT**: Память агента и история чата синхронизируются как CRDT-структуры, позволяя нескольким агентам (или человеку и агенту) одновременно редактировать контекст без конфликтов.
-   **Proactive Pruning**: Ядро ОС автоматически сжимает (summarize) старые состояния, чтобы они умещались в контекстное окно LLM.

---
*Состояние в tLOS — это не база данных, а распределенный поток намерений.*
