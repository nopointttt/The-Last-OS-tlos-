# Spatial System: The Infinite Canvas Math

Этот документ описывает математическую и архитектурную основу пространственной системы **The Last OS (tLOS)**. Система спроектирована как бесконечный холст (Infinite Canvas), где данные и актёры сосуществуют в распределенном 2D-пространстве.

---

## 1. Архитектурная модель: Spatial-C4
Для документации tLOS мы используем расширенную модель **C4**, адаптированную под пространственные (Space-Based) системы.

- **Level 1: System Context**: Взаимодействие Суверена (User) с Латицей (Lattice).
- **Level 2: Spatial Container**: Описание "узлов-шардов" и механизмов проекции Lattice -> Shell.
- **Level 3: Component (Spatial Index)**: Детальное описание Quadtree-индексатора.
- **Level 4: Spatial API (WIT)**: Интерфейсы `tlos:spatial/movement` и `tlos:spatial/query`.

---

## 1.1. Оптимизация групповых взаимодействий
Для обеспечения 60 FPS при манипуляции группами окон (Double-click select) Shell использует следующие техники:
- **Shared Signal (`groupTransform`)**: В основном цикле SolidJS создается единый сигнал, транслирующий дельту движения "ведущего" окна всем остальным участникам группы.
- **Visual Overrides**: Дочерние компоненты используют `createMemo` для вычисления `visualPos` на лету, не дожидаясь завершения основной транзакции в Lattice.
- **Snapshot Baseline**: Перед началом группового драга захватывается снимок исходных координат (`initialRects`), что предотвращает накопление ошибок округления и "дрейф" окон.

---

## 2. Математика Бесконечности (Infinite Space)
tLOS реализует "иллюзию бесконечности" через детерминированное шардирование пространства.

### 2.1. Система Координат
Мы используем 64-битную систему координат с фиксированной точкой (Fixed-point 48.16) для предотвращения дрожания (jittering) при больших удалениях от начала координат.
- **Мир**: Бесконечная сетка чанков (Chunks).
- **Чанк**: Область $2^{16} \times 2^{16}$ единиц пространства.
- **Адресация**: Индекс чанка вычисляется как $ID = Hash(X_{chunk}, Y_{chunk})$.

### 2.2. Spatial Indexing: CRDT Quadtree
Для синхронизации положения актёров между узлами Lattice используется комбинация **Quadtree** и **CRDT**:
- **Z-Order Curve (Morton Code)**: Перевод 2D-координат в 1D-индекс для эффективного хранения в ключе-значении.
- **Eventually Consistent Spatial State**: Удаление и добавление точек в дерево происходит без центрального блокировщика через LWW-Element-Set (Last-Write-Wins).

---

## 3. Проекция и Рендеринг (Lattice Projection)
Процесс превращения распределенных данных в визуальный интерфейс.

### 3.1. Видимый объем (Camera Frustum)
Оболочка (Shell) запрашивает у Ядра только те объекты, которые попадают в её текущий вьюпорт:
1.  **Query**: `get_entities_in_rect(viewport_bounds)`
2.  **Lifting**: Преобразование бинарных данных (GeoArrow) в GPU-буферы.
3.  **WGPU Pipeline**: Отрисовка через инстансинг для тысяч агентов на 60 FPS.

### 3.2. Слои Изоляции (Spatial MPK)
Мы используем аппаратную раскраску памяти (**Memory Protection Keys**) для разделения данных разных пространственных квадрантов. Это гарантирует, что агент из квадранта A физически не может "подсмотреть" память агента в квадранте B, если они не находятся в зоне прямой видимости.

---

## 4. Протокол Координации AI-Агентов
Агенты перемещаются в пространстве, следуя правилам "Sovereign Intent":
- **Spatial Handover**: Когда агент пересекает границу чанка, его состояние передается другому узлу Lattice (NATS subject migration).
- **Collision Boundary**: Математическая проверка коллизий на уровне ядра (WIT-interface `tlos:spatial/physics`).

---

## 5. Физика взаимодействия (Interaction Physics)
Для обеспечения естественного отклика интерфейса ("The Smooth Move") в tLOS реализованы следующие правила:
- **Smooth Transform**: Избегание тяжелых синхронных обновлений состояния во время драга. Обновление координат происходит в Shell через CPU-интерполяцию и CSS-переменные, и фиксируется в Lattice только после завершения действия.
- **Principle of Separation (Break on Move)**: Любое одиночное движение окна, прикрепленного к другому (`attachedTo`), автоматически разрывает магнитную связь. Система отдает приоритет воле Суверена над автоматическим объединением.

---
*Документ объединяет принципы Space-Based Architecture и возможности WGPU/Wasm 2026 года.*
