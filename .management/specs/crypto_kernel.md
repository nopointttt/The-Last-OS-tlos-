# Spec: Crypto-Kernel (PQC Integration)

**Status**: Draft

## 1. Контекст и Проблема
*   **Research**: [cryptography.md](file:///c:/nopoint/The%20Last%20OS/researches/cryptography.md)
*   **Проблема**: Текущие методы аутентификации и шифрования (Ed25519/X25519) уязвимы для будущих квантовых компьютеров. Нам нужен фундамент, соответствующий стандартам NIST 2026 (ML-KEM, ML-DSA).
*   **Почему это важно**: Безопасность "The Last OS" должна быть долговечной. Использование формально верифицированных библиотек снижает риск ошибок реализации.

*   **Решение (The Bet)**: Внедрение гибридного режима (Hybrid Mode) шифрования. Мы комбинируем классические алгоритмы (X25519) с пост-квантовыми (ML-KEM-768) с использованием библиотеки `ml-kem` от RustCrypto. Это гарантирует беспроблемную сборку под Wasm без зависимости от `clang`.
*   **Архитектура**:
    *   `CryptoManager` в ядре (Rust) управляет жизненным циклом ключей.
    *   Wasm-инстанс получает энтропию через JS-мост (`getrandom` с фичей `js`).

## 3. Scope (Границы)
### In Scope (Что делаем)
*   [ ] Добавление зависимостей `ml-kem` и `getrandom` в `kernel/`.
*   [ ] Реализация структуры `CryptoManager`.
*   [ ] Реализация гибридного обмена ключами (X25519 + ML-KEM).
*   [ ] Проброс системных вызовов для Shell: `sys_gen_keys`, `sys_encrypt_hybrid`, `sys_decrypt_hybrid`.

### Out of Scope (Что НЕ делаем)
*   [ ] Полная миграция всей аутентификации на PQC (только фундамент).
*   [ ] Оптимизация производительности под мобильные устройства на этом этапе.

### Rabbit Holes (Риски)
*   **Wasm Randomness**: Если `wasm-bindgen` не сможет корректно привязаться к `crypto.getRandomValues()`, ядро запаникует. Нужна строгая проверка в Shell.
*   **Размер ключей**: Пост-квантовые ключи значительно больше классических (Kyber768 public key ~1184 bytes vs X25519 32 bytes). Это влияет на сетевой протокол.

## 4. Технические Детали
*   **Стек**: Rust (Edition 2021), `ml-kem` v0.2+, `getrandom` v0.2.14+.
*   **Constraints**: Работа внутри Wasm-песочницы.
